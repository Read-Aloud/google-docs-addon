<script>
  const engine = webSpeechEngine
  voices = null
  options = {}
  progress = 0
  error = null
  activeSpeech = null
  $(docReady)

  async function docReady() {
    voices = await loadVoices()
  }

  function loadVoices() {
    return engine.getVoices()
  }

  async function readAloud() {
    if (!options.voice) return error = {message: "Please select a voice"}
    try {
      error = null
      progress++
      var currentIndex = await new Promise((f,r) => gsRun(f,r).getCurrentIndex())
      var getNextText = async function() {
        var text = ""
        while (text == "") {
          text = await new Promise((f,r) => gsRun(f,r).getText(currentIndex))
          currentIndex++
        }
        return text
      }
      var text = await getNextText()
      while (text) {
        console.log(text)
        activeSpeech = new Speech(text, options)
        await activeSpeech.play()
        progress--
        const nextTextPromise = getNextText()
        await new Promise(f => activeSpeech.onEnd = f)
        progress++
        text = await nextTextPromise
      }
    }
    catch(err) {
      error = err
    }
    finally {
      progress = 0
      activeSpeech = null
    }
  }
</script>
