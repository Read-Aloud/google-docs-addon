<script>
  voices = null
  options = {}
  progress = 0
  error = null
  activeSpeech = null
  $(docReady)

  async function docReady() {
    voices = await loadVoices()
  }

  function loadVoices() {
    return webSpeechEngine.getVoices()
  }

  async function readAloud() {
    if (!options.voice) return error = {message: "Please select a voice"}
    try {
      error = null
      progress++
      var current = await new Promise((f,r) => gsRun(f,r).getTextCurrent())
      while (current) {
        var promise = new Promise((f,r) => gsRun(f,r).batch([
          {method: "setSelection", args: [current.index]},
          {method: "getText", args: [current.index+1]}
        ]))
        console.log(current.index, current.text)
        activeSpeech = new Speech(current.text, options)
        await activeSpeech.play()
        progress--
        await new Promise(f => activeSpeech.onEnd = f)
        progress++
        current = (await promise)[1]
      }
    }
    catch(err) {
      error = err
    }
    finally {
      progress = 0
      activeSpeech = null
    }
  }
</script>
